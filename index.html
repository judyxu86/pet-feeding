<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸Šé—¨å–‚å…»å°åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #f5e6ff 0%, #fff5e6 100%);
            min-height: 100vh;
            padding-bottom: 2rem;
        }
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .input-focus:focus {
            outline: none;
            border-color: #d8b4fe;
            box-shadow: 0 0 0 3px rgba(216, 180, 254, 0.1);
        }
        .checkbox-wrapper {
            position: relative;
        }
        .checkbox-wrapper input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }
        .checkbox-wrapper label {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        .checkbox-custom {
            width: 20px;
            height: 20px;
            border: 2px solid #d1d5db;
            border-radius: 4px;
            margin-right: 10px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            background: white;
        }
        .checkbox-wrapper input[type="checkbox"]:checked + label .checkbox-custom {
            background: #e9d5ff;
            border-color: #a855f7;
        }
        .checkbox-wrapper input[type="checkbox"]:checked + label .checkbox-custom::after {
            content: 'âœ“';
            color: #7c3aed;
            font-weight: bold;
            font-size: 14px;
        }
        .checkbox-wrapper input[type="checkbox"]:hover + label .checkbox-custom {
            border-color: #a855f7;
        }
        .toggle-btn {
            background: white;
            border: 2px solid #d1d5db;
            color: #374151;
            transition: all 0.2s;
            cursor: pointer;
            user-select: none;
        }
        .toggle-btn.active {
            background: #e9d5ff;
            border-color: #a855f7;
            color: #7c3aed;
        }
        /* ä¿®å¤ï¼šç…§ç‰‡å®Œæ•´æ˜¾ç¤º */
        .photo-preview {
            width: 100%;
            max-height: none;
            height: auto;
            object-fit: contain;
            border-radius: 12px;
        }
        .photo-preview-container {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 12px;
        }
        .report-card {
            background: linear-gradient(135deg, #fff9f0 0%, #fff5e6 100%);
            border: 2px solid #d8b4fe;
        }
        .pet-input-group {
            display: flex;
            gap: 0.5rem;
            align-items: flex-start;
        }
        .pet-input-wrapper {
            flex: 1;
        }
        /* ä¿®å¤ï¼šç¡®ä¿è¾“å…¥æ¡†åœ¨æ‰‹æœºä¸Šä¸ä¼šè¶…å‡º */
        input, select, textarea {
            max-width: 100%;
            width: 100%;
        }
        .container-padding {
            padding-left: 1rem;
            padding-right: 1rem;
        }
        .qr-container {
            background: white;
            padding: 1rem;
            border-radius: 12px;
            display: inline-block;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e9d5ff;
            border-top-color: #a855f7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* å–‚é£Ÿç±»å‹å¸¦å“ç‰Œè¾“å…¥ */
        .feeding-type-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .feeding-type-row .checkbox-wrapper {
            flex-shrink: 0;
        }
        .feeding-type-row input[type="text"] {
            flex: 1;
            min-width: 120px;
            padding: 0.5rem;
            font-size: 0.875rem;
        }
        /* å°ç…§ç‰‡ä¸Šä¼ æŒ‰é’® */
        .small-photo-btn {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            border-radius: 0.75rem;
        }
        .small-photo-preview {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 8px;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body class="container-padding">
    <!-- åŠ è½½ä¸­é®ç½© -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-600">æ­£åœ¨ä¿å­˜...</p>
        </div>
    </div>

    <!-- å¡«å†™é¡µ -->
    <div id="formPage" class="max-w-md mx-auto pt-6">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ¾ ä¸Šé—¨å–‚å…»å°åŠ©æ‰‹</h1>
            <p class="text-gray-600 text-sm">è®°å½•æ¯ä¸€æ¬¡è´´å¿ƒçš„æœåŠ¡</p>
        </div>

        <form id="feedingForm" class="space-y-5">
            <!-- åŸºç¡€ä¿¡æ¯ -->
            <div class="bg-white rounded-2xl p-5 card-shadow">
                <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <span class="mr-2">ğŸ“…</span> åŸºç¡€ä¿¡æ¯
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ—¥æœŸ</label>
                        <input type="date" id="serviceDate" required
                            class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 input-focus text-gray-800">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å¼€å§‹æ—¶é—´</label>
                            <input type="time" id="serviceStartTime" required
                                class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 input-focus text-gray-800">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ç»“æŸæ—¶é—´</label>
                            <input type="time" id="serviceEndTime"
                                class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 input-focus text-gray-800">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å®¢æˆ·åœ°å€</label>
                        <input type="text" id="customerAddress" placeholder="è¯·è¾“å…¥å®¢æˆ·åœ°å€" required
                            class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 input-focus text-gray-800">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ä¸»äººå§“å</label>
                        <input type="text" id="ownerName" placeholder="è¯·è¾“å…¥ä¸»äººå§“å" required
                            class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 input-focus text-gray-800">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å® ç‰©æ˜µç§°</label>
                        <div id="petNamesContainer">
                            <div class="pet-input-group mb-2">
                                <div class="pet-input-wrapper">
                                    <input type="text" name="petName" placeholder="è¯·è¾“å…¥å® ç‰©æ˜µç§°" required
                                        class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 input-focus text-gray-800">
                                </div>
                            </div>
                        </div>
                        <button type="button" id="addPetBtn" 
                            class="w-full mt-2 px-4 py-2 rounded-xl border-2 border-dashed border-purple-300 text-purple-600 hover:bg-purple-50 transition-all text-sm font-medium">
                            + æ·»åŠ å® ç‰©
                        </button>
                    </div>
                </div>
            </div>

            <!-- é¥®é£Ÿç…§æ–™ -->
            <div class="bg-white rounded-2xl p-5 card-shadow">
                <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <span class="mr-2">ğŸ½ï¸</span> é¥®é£Ÿç…§æ–™
                </h2>
                <div class="space-y-4">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="bowlCleaned">
                        <label for="bowlCleaned">
                            <span class="checkbox-custom"></span>
                            <span class="text-gray-700">ç²®ç¢—/æ°´ç¢—æ¸…æ´—</span>
                        </label>
                    </div>

                    <!-- å–‚é£Ÿç±»å‹ï¼ˆå¸¦å“ç‰Œè¾“å…¥ï¼‰ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">å–‚é£Ÿç±»å‹</label>
                        <div class="space-y-3">
                            <div class="feeding-type-row">
                                <div class="checkbox-wrapper">
                                    <input type="checkbox" id="feedingTypeDry" name="feedingType" value="å¹²ç²®">
                                    <label for="feedingTypeDry">
                                        <span class="checkbox-custom"></span>
                                        <span class="text-gray-700">å¹²ç²®</span>
                                    </label>
                                </div>
                                <input type="text" id="feedingBrandDry" placeholder="å“ç‰Œï¼ˆé€‰å¡«ï¼‰"
                                    class="rounded-lg border-2 border-gray-200 input-focus text-gray-800 text-sm">
                            </div>
                            <div class="feeding-type-row">
                                <div class="checkbox-wrapper">
                                    <input type="checkbox" id="feedingTypeWet" name="feedingType" value="æ¹¿ç²®">
                                    <label for="feedingTypeWet">
                                        <span class="checkbox-custom"></span>
                                        <span class="text-gray-700">æ¹¿ç²®</span>
                                    </label>
                                </div>
                                <input type="text" id="feedingBrandWet" placeholder="å“ç‰Œï¼ˆé€‰å¡«ï¼‰"
                                    class="rounded-lg border-2 border-gray-200 input-focus text-gray-800 text-sm">
                            </div>
                            <div class="feeding-type-row">
                                <div class="checkbox-wrapper">
                                    <input type="checkbox" id="feedingTypeCan" name="feedingType" value="ç½å¤´">
                                    <label for="feedingTypeCan">
                                        <span class="checkbox-custom"></span>
                                        <span class="text-gray-700">ç½å¤´</span>
                                    </label>
                                </div>
                                <input type="text" id="feedingBrandCan" placeholder="å“ç‰Œï¼ˆé€‰å¡«ï¼‰"
                                    class="rounded-lg border-2 border-gray-200 input-focus text-gray-800 text-sm">
                            </div>
                            <div class="feeding-type-row">
                                <div class="checkbox-wrapper">
                                    <input type="checkbox" id="feedingTypeSnack" name="feedingType" value="é›¶é£Ÿ">
                                    <label for="feedingTypeSnack">
                                        <span class="checkbox-custom"></span>
                                        <span class="text-gray-700">é›¶é£Ÿ</span>
                                    </label>
                                </div>
                                <input type="text" id="feedingBrandSnack" placeholder="å“ç‰Œï¼ˆé€‰å¡«ï¼‰"
                                    class="rounded-lg border-2 border-gray-200 input-focus text-gray-800 text-sm">
                            </div>
                        </div>
                    </div>

                    <!-- å–‚é£Ÿé‡ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å–‚é£Ÿé‡</label>
                        <div class="flex gap-2 items-center">
                            <input type="number" id="feedingAmount" placeholder="æ•°é‡" min="0"
                                class="flex-1 px-4 py-3 rounded-xl border-2 border-gray-200 input-focus text-gray-800">
                            <select id="feedingUnit" class="px-4 py-3 rounded-xl border-2 border-gray-200 input-focus text-gray-800">
                                <option value="g">å…‹ (g)</option>
                                <option value="ä»½">ä»½</option>
                                <option value="åŒ…">åŒ…</option>
                                <option value="ç½">ç½</option>
                            </select>
                        </div>
                    </div>

                    <!-- æœåŠ¡å‰è¿›é£Ÿæƒ…å†µ -->
                    <div class="bg-gray-50 rounded-xl p-4">
                        <label class="block text-sm font-medium text-gray-700 mb-3">æœåŠ¡å‰ï¼ˆåŸæœ‰ç²®ï¼‰è¿›é£Ÿæƒ…å†µ</label>
                        <div class="flex flex-wrap gap-2 mb-3">
                            <button type="button" class="toggle-btn px-3 py-2 rounded-xl text-sm" data-group="eatingBefore" data-value="åƒå®Œäº†">åƒå®Œäº†</button>
                            <button type="button" class="toggle-btn px-3 py-2 rounded-xl text-sm" data-group="eatingBefore" data-value="åƒäº†å¤§éƒ¨åˆ†">åƒäº†å¤§éƒ¨åˆ†</button>
                            <button type="button" class="toggle-btn px-3 py-2 rounded-xl text-sm" data-group="eatingBefore" data-value="åƒäº†ä¸€ç‚¹">åƒäº†ä¸€ç‚¹</button>
                            <button type="button" class="toggle-btn px-3 py-2 rounded-xl text-sm" data-group="eatingBefore" data-value="æ²¡æ€ä¹ˆåƒ">æ²¡æ€ä¹ˆåƒ</button>
                        </div>
                        <input type="file" id="eatingBeforePhotoInput" accept="image/*" class="hidden">
                        <button type="button" class="small-photo-btn border-2 border-dashed border-purple-300 text-purple-600 hover:bg-purple-50 transition-all" onclick="document.getElementById('eatingBeforePhotoInput').click()">
                            ğŸ“· æ·»åŠ ç…§ç‰‡
                        </button>
                        <div id="eatingBeforePhotoPreview" class="hidden">
                            <img id="eatingBeforePhoto" class="small-photo-preview">
                            <button type="button" class="text-red-500 text-xs mt-1" onclick="removePhoto('eatingBefore')">åˆ é™¤</button>
                        </div>
                    </div>

                    <!-- æœåŠ¡æ—¶è¿›é£Ÿæƒ…å†µ -->
                    <div class="bg-gray-50 rounded-xl p-4">
                        <label class="block text-sm font-medium text-gray-700 mb-3">æœåŠ¡æ—¶ï¼ˆæ–°ç»™ç²®ï¼‰è¿›é£Ÿæƒ…å†µ</label>
                        <div class="flex flex-wrap gap-2 mb-3">
                            <button type="button" class="toggle-btn px-3 py-2 rounded-xl text-sm" data-group="eatingDuring" data-value="åƒå¾—å¾ˆé¦™">åƒå¾—å¾ˆé¦™</button>
                            <button type="button" class="toggle-btn px-3 py-2 rounded-xl text-sm" data-group="eatingDuring" data-value="æ­£å¸¸è¿›é£Ÿ">æ­£å¸¸è¿›é£Ÿ</button>
                            <button type="button" class="toggle-btn px-3 py-2 rounded-xl text-sm" data-group="eatingDuring" data-value="åƒäº†ä¸€ç‚¹">åƒäº†ä¸€ç‚¹</button>
                            <button type="button" class="toggle-btn px-3 py-2 rounded-xl text-sm" data-group="eatingDuring" data-value="æ²¡æ€ä¹ˆåƒ">æ²¡æ€ä¹ˆåƒ</button>
                        </div>
                        <input type="file" id="eatingDuringPhotoInput" accept="image/*" class="hidden">
                        <button type="button" class="small-photo-btn border-2 border-dashed border-purple-300 text-purple-600 hover:bg-purple-50 transition-all" onclick="document.getElementById('eatingDuringPhotoInput').click()">
                            ğŸ“· æ·»åŠ ç…§ç‰‡
                        </button>
                        <div id="eatingDuringPhotoPreview" class="hidden">
                            <img id="eatingDuringPhoto" class="small-photo-preview">
                            <button type="button" class="text-red-500 text-xs mt-1" onclick="removePhoto('eatingDuring')">åˆ é™¤</button>
                        </div>
                    </div>

                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="waterChanged">
                        <label for="waterChanged">
                            <span class="checkbox-custom"></span>
                            <span class="text-gray-700">å·²æ¢æ°´</span>
                        </label>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é¥®é£Ÿå¤‡æ³¨</label>
                        <input type="text" id="dietNotes" placeholder="å¦‚æœ‰ç‰¹æ®Šæƒ…å†µè¯·å¤‡æ³¨"
                            class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 input-focus text-gray-800">
                    </div>
                </div>
            </div>

            <!-- å® ç‰©çŠ¶æ€ï¼ˆç§»åˆ°è¿™é‡Œï¼‰ -->
            <div class="bg-white rounded-2xl p-5 card-shadow">
                <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <span class="mr-2">ğŸ˜º</span> å® ç‰©çŠ¶æ€
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">ç²¾ç¥çŠ¶æ€</label>
                        <div class="flex flex-wrap gap-2">
                            <button type="button" class="toggle-btn px-4 py-2 rounded-xl text-sm" data-group="mood" data-value="æ´»æ³¼å¥½åŠ¨">æ´»æ³¼å¥½åŠ¨</button>
                            <button type="button" class="toggle-btn px-4 py-2 rounded-xl text-sm" data-group="mood" data-value="æ­£å¸¸">æ­£å¸¸</button>
                            <button type="button" class="toggle-btn px-4 py-2 rounded-xl text-sm" data-group="mood" data-value="æ¯”è¾ƒå®‰é™">æ¯”è¾ƒå®‰é™</button>
                            <button type="button" class="toggle-btn px-4 py-2 rounded-xl text-sm" data-group="mood" data-value="çŠ¶æ€å¼‚å¸¸">çŠ¶æ€å¼‚å¸¸</button>
                        </div>
                    </div>

                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="playInteraction">
                        <label for="playInteraction">
                            <span class="checkbox-custom"></span>
                            <span class="text-gray-700">é™ªç©äº’åŠ¨</span>
                        </label>
                    </div>

                    <div id="playDurationContainer" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">é™ªç©æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</label>
                        <input type="number" id="playDuration" placeholder="è¯·è¾“å…¥åˆ†é’Ÿæ•°" min="1"
                            class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 input-focus text-gray-800">
                    </div>

                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="grooming">
                        <label for="grooming">
                            <span class="checkbox-custom"></span>
                            <span class="text-gray-700">æ¢³æ¯›</span>
                        </label>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å® ç‰©çŠ¶æ€å¤‡æ³¨</label>
                        <input type="text" id="petStatusNotes" placeholder="å¦‚æœ‰ç‰¹æ®Šæƒ…å†µè¯·å¤‡æ³¨"
                            class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 input-focus text-gray-800">
                    </div>
                </div>
            </div>

            <!-- å«ç”Ÿæ¸…æ´ -->
            <div class="bg-white rounded-2xl p-5 card-shadow">
                <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <span class="mr-2">ğŸ’©</span> å«ç”Ÿæ¸…æ´
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">æ’ä¾¿æƒ…å†µ</label>
                        <div class="flex flex-wrap gap-2">
                            <button type="button" class="toggle-btn px-4 py-2 rounded-xl text-sm" data-group="poop" data-value="æ­£å¸¸">æ­£å¸¸</button>
                            <button type="button" class="toggle-btn px-4 py-2 rounded-xl text-sm" data-group="poop" data-value="åè½¯">åè½¯</button>
                            <button type="button" class="toggle-btn px-4 py-2 rounded-xl text-sm" data-group="poop" data-value="æ‹‰ç¨€">æ‹‰ç¨€</button>
                            <button type="button" class="toggle-btn px-4 py-2 rounded-xl text-sm" data-group="poop" data-value="ä¾¿ç§˜">ä¾¿ç§˜</button>
                            <button type="button" class="toggle-btn px-4 py-2 rounded-xl text-sm" data-group="poop" data-value="æœªå‘ç°">æœªå‘ç°</button>
                        </div>
                    </div>

                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="poopHasHair">
                        <label for="poopHasHair">
                            <span class="checkbox-custom"></span>
                            <span class="text-gray-700">ä¾¿ä¾¿æœ‰æ¯›å‘</span>
                        </label>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ’ä¾¿å¤‡æ³¨</label>
                        <input type="text" id="poopNotes" placeholder="å¦‚æœ‰ç‰¹æ®Šæƒ…å†µè¯·å¤‡æ³¨"
                            class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 input-focus text-gray-800">
                    </div>

                    <!-- å°¿å›¢ï¼ˆæ‹†åˆ†ï¼‰ -->
                    <div class="bg-gray-50 rounded-xl p-4">
                        <label class="block text-sm font-medium text-gray-700 mb-3">å°¿å›¢æƒ…å†µ</label>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">æ•°é‡</label>
                                <input type="number" id="urineCount" placeholder="å‡ ä¸ª" min="0"
                                    class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 input-focus text-gray-800 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">å¤§å°</label>
                                <div class="flex flex-wrap gap-1">
                                    <button type="button" class="toggle-btn px-3 py-1 rounded-lg text-xs" data-group="urineSize" data-value="æ­£å¸¸">æ­£å¸¸</button>
                                    <button type="button" class="toggle-btn px-3 py-1 rounded-lg text-xs" data-group="urineSize" data-value="åå¤§">åå¤§</button>
                                    <button type="button" class="toggle-btn px-3 py-1 rounded-lg text-xs" data-group="urineSize" data-value="åå°">åå°</button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">å°¿å›¢å¼‚å¸¸</label>
                            <div class="flex flex-wrap gap-1 mb-3">
                                <button type="button" class="toggle-btn px-3 py-1 rounded-lg text-xs" data-group="urineAbnormal" data-value="æ— å¼‚å¸¸">æ— å¼‚å¸¸</button>
                                <button type="button" class="toggle-btn px-3 py-1 rounded-lg text-xs" data-group="urineAbnormal" data-value="é¢œè‰²æ·±">é¢œè‰²æ·±</button>
                                <button type="button" class="toggle-btn px-3 py-1 rounded-lg text-xs" data-group="urineAbnormal" data-value="é¢œè‰²æµ…">é¢œè‰²æµ…</button>
                                <button type="button" class="toggle-btn px-3 py-1 rounded-lg text-xs" data-group="urineAbnormal" data-value="æœ‰è¡€ä¸">æœ‰è¡€ä¸</button>
                                <button type="button" class="toggle-btn px-3 py-1 rounded-lg text-xs" data-group="urineAbnormal" data-value="æ°”å‘³å¼‚å¸¸">æ°”å‘³å¼‚å¸¸</button>
                                <button type="button" class="toggle-btn px-3 py-1 rounded-lg text-xs" data-group="urineAbnormal" data-value="ç»“å—å¼‚å¸¸">ç»“å—å¼‚å¸¸</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">å°¿å›¢å¤‡æ³¨</label>
                            <input type="text" id="urineNotes" placeholder="å¦‚æœ‰ç‰¹æ®Šæƒ…å†µè¯·å¤‡æ³¨"
                                class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 input-focus text-gray-800 text-sm">
                        </div>
                    </div>

                    <!-- æ’æ³„ç‰©ç…§ç‰‡ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ’æ³„ç‰©ç…§ç‰‡</label>
                        <input type="file" id="wastePhotoInput" accept="image/*" class="hidden">
                        <button type="button" class="w-full px-4 py-2 rounded-xl border-2 border-dashed border-purple-300 text-purple-600 hover:bg-purple-50 transition-all text-sm" onclick="document.getElementById('wastePhotoInput').click()">
                            ğŸ“· ä¸Šä¼ ç²‘ç²‘/å°¿å›¢ç…§ç‰‡
                        </button>
                        <div id="wastePhotoPreview" class="hidden mt-2">
                            <img id="wastePhoto" class="small-photo-preview">
                            <button type="button" class="text-red-500 text-xs mt-1" onclick="removePhoto('waste')">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å‘•åæƒ…å†µ -->
            <div class="bg-white rounded-2xl p-5 card-shadow">
                <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <span class="mr-2">ğŸ¤®</span> å‘•åæƒ…å†µ
                </h2>
                <div class="space-y-4">
                    <div class="flex gap-2">
                        <button type="button" class="toggle-btn px-4 py-2 rounded-xl text-sm flex-1" data-group="vomit" data-value="æœªå‘ç°å‘•åç‰©">æœªå‘ç°å‘•åç‰©</button>
                        <button type="button" class="toggle-btn px-4 py-2 rounded-xl text-sm flex-1" data-group="vomit" data-value="å‘ç°å‘•åç‰©">å‘ç°å‘•åç‰©</button>
                    </div>

                    <div id="vomitDetails" class="hidden space-y-3">
                        <label class="block text-sm font-medium text-gray-700">å‘•åç‰©ç±»å‹</label>
                        <div class="space-y-2">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="vomitTypeHairball" name="vomitType" value="æ¯›çƒ">
                                <label for="vomitTypeHairball">
                                    <span class="checkbox-custom"></span>
                                    <span class="text-gray-700">æ¯›çƒ</span>
                                </label>
                            </div>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="vomitTypeFood" name="vomitType" value="æœªæ¶ˆåŒ–çš„é£Ÿç‰©">
                                <label for="vomitTypeFood">
                                    <span class="checkbox-custom"></span>
                                    <span class="text-gray-700">æœªæ¶ˆåŒ–çš„é£Ÿç‰©</span>
                                </label>
                            </div>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="vomitTypeLiquid" name="vomitType" value="æ¶²ä½“/æ³¡æ²«">
                                <label for="vomitTypeLiquid">
                                    <span class="checkbox-custom"></span>
                                    <span class="text-gray-700">æ¶²ä½“/æ³¡æ²«</span>
                                </label>
                            </div>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="vomitTypeOther" name="vomitType" value="å…¶ä»–">
                                <label for="vomitTypeOther">
                                    <span class="checkbox-custom"></span>
                                    <span class="text-gray-700">å…¶ä»–</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å‘•åå¤‡æ³¨</label>
                            <input type="text" id="vomitNotes" placeholder="æè¿°å‘•åç‰©æƒ…å†µ"
                                class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 input-focus text-gray-800">
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç¯å¢ƒæ£€æŸ¥ -->
            <div class="bg-white rounded-2xl p-5 card-shadow">
                <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <span class="mr-2">ğŸ </span> ç¯å¢ƒæ£€æŸ¥
                </h2>
                <div class="space-y-3">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="doorWindowChecked">
                        <label for="doorWindowChecked">
                            <span class="checkbox-custom"></span>
                            <span class="text-gray-700">é—¨çª—å·²ç¡®è®¤é”å¥½</span>
                        </label>
                    </div>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="utilitiesChecked">
                        <label for="utilitiesChecked">
                            <span class="checkbox-custom"></span>
                            <span class="text-gray-700">æ°´ç”µ/ç©ºè°ƒå·²å¤åŸ</span>
                        </label>
                    </div>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="surroundingCleaned">
                        <label for="surroundingCleaned">
                            <span class="checkbox-custom"></span>
                            <span class="text-gray-700">å‘¨è¾¹æ¸…æ´/è¡¥ç ‚</span>
                        </label>
                    </div>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="trashHandled">
                        <label for="trashHandled">
                            <span class="checkbox-custom"></span>
                            <span class="text-gray-700">åƒåœ¾å·²å¤„ç†</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- ç…§ç‰‡ä¸Šä¼  -->
            <div class="bg-white rounded-2xl p-5 card-shadow">
                <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <span class="mr-2">ğŸ“·</span> æ‹ç…§è®°å½•
                </h2>
                <div class="space-y-4">
                    <input type="file" id="photoInput" accept="image/*" class="hidden">
                    <button type="button" id="uploadPhotoBtn" 
                        class="w-full px-4 py-3 rounded-xl border-2 border-dashed border-purple-300 text-purple-600 hover:bg-purple-50 transition-all">
                        ğŸ“· ç‚¹å‡»ä¸Šä¼ ç…§ç‰‡
                    </button>
                    <div id="photoPreviewContainer" class="hidden">
                        <div class="photo-preview-container">
                            <img id="photoPreview" class="photo-preview w-full">
                        </div>
                        <button type="button" id="removePhotoBtn" class="mt-2 text-red-500 text-sm">åˆ é™¤ç…§ç‰‡</button>
                    </div>
                </div>
            </div>

            <!-- å¤‡æ³¨ -->
            <div class="bg-white rounded-2xl p-5 card-shadow">
                <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <span class="mr-2">ğŸ“</span> å…¶ä»–å¤‡æ³¨
                </h2>
                <textarea id="notes" rows="3" placeholder="å…¶ä»–éœ€è¦å‘ŠçŸ¥ä¸»äººçš„äº‹é¡¹..."
                    class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 input-focus text-gray-800 resize-none"></textarea>
            </div>

            <!-- æäº¤æŒ‰é’® -->
            <button type="submit" 
                class="w-full py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold rounded-2xl shadow-lg hover:shadow-xl transition-all active:scale-98">
                ç”ŸæˆæŠ¥å‘Š âœ¨
            </button>
        </form>
    </div>

    <!-- æŠ¥å‘Šé¡µ -->
    <div id="reportPage" class="max-w-md mx-auto pt-6 hidden">
        <div class="text-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">ğŸ¾ å–‚å…»æŠ¥å‘Š</h1>
            <p class="text-gray-600 text-sm">æŠ¥å‘Šå·²ç”Ÿæˆï¼Œå¯åˆ†äº«ç»™å®¢æˆ·</p>
        </div>

        <div class="report-card rounded-2xl p-5 card-shadow mb-5">
            <div class="space-y-4">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-600 text-sm">ğŸ“ åœ°å€</p>
                        <p id="reportAddress" class="font-medium text-gray-800"></p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-gray-600 text-sm">ğŸ‘¤ ä¸»äºº</p>
                        <p id="reportOwner" class="font-medium text-gray-800"></p>
                    </div>
                    <div>
                        <p class="text-gray-600 text-sm">ğŸ¾ å® ç‰©</p>
                        <p id="reportPets" class="font-medium text-gray-800"></p>
                    </div>
                </div>
                <div>
                    <p class="text-gray-600 text-sm">ğŸ“… æœåŠ¡æ—¶é—´</p>
                    <p id="reportDateTime" class="font-medium text-gray-800"></p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl p-5 card-shadow space-y-4 mb-5">
            <div>
                <p class="text-gray-600 text-sm mb-1">ğŸ˜º å® ç‰©çŠ¶æ€</p>
                <p id="reportMood" class="text-gray-800"></p>
            </div>
            <div id="reportPlayContainer" class="hidden">
                <p class="text-gray-600 text-sm mb-1">ğŸ® é™ªç©äº’åŠ¨</p>
                <p id="reportPlay" class="text-gray-800"></p>
            </div>
            <div id="reportGroomingContainer" class="hidden">
                <p class="text-gray-600 text-sm mb-1">âœ¨ æ¢³æ¯›</p>
                <p>å·²æ¢³æ¯›</p>
            </div>
            <div id="reportPetStatusNotesContainer" class="hidden">
                <p class="text-gray-600 text-sm mb-1">ğŸ“ å® ç‰©çŠ¶æ€å¤‡æ³¨</p>
                <p id="reportPetStatusNotes" class="text-gray-800"></p>
            </div>
            <div>
                <p class="text-gray-600 text-sm mb-1">ğŸ½ï¸ é¥®é£Ÿç…§æ–™</p>
                <p id="reportFeeding" class="text-gray-800"></p>
            </div>
            <div>
                <p class="text-gray-600 text-sm mb-1">ğŸ’© å«ç”Ÿæ¸…æ´</p>
                <p id="reportCleaning" class="text-gray-800"></p>
            </div>
            <div id="reportVomitContainer" class="hidden">
                <p class="text-gray-600 text-sm mb-1">ğŸ¤® å‘•åæƒ…å†µ</p>
                <p id="reportVomit" class="text-gray-800"></p>
            </div>
            <div>
                <p class="text-gray-600 text-sm mb-1">ğŸ  ç¯å¢ƒæ£€æŸ¥</p>
                <p id="reportEnvironment" class="text-gray-800"></p>
            </div>
            <div id="reportNotesContainer" class="hidden">
                <p class="text-gray-600 text-sm mb-1">ğŸ“ å¤‡æ³¨</p>
                <p id="reportNotes" class="text-gray-800"></p>
            </div>
            <div id="reportPhotoContainer" class="hidden">
                <p class="text-gray-600 text-sm mb-1">ğŸ“· ç…§ç‰‡</p>
                <div class="photo-preview-container">
                    <img id="reportPhoto" class="photo-preview w-full mt-2">
                </div>
            </div>
        </div>

        <!-- äºŒç»´ç åˆ†äº«åŒºåŸŸ -->
        <div class="bg-white rounded-2xl p-5 card-shadow mb-5 text-center">
            <h3 class="font-semibold text-gray-800 mb-3">ğŸ“± åˆ†äº«ç»™å®¢æˆ·</h3>
            <div class="qr-container mb-3">
                <img id="qrcode" alt="äºŒç»´ç " style="width: 200px; height: 200px;">
            </div>
            <p class="text-sm text-gray-500 mb-3">å®¢æˆ·æ‰«ç å³å¯æŸ¥çœ‹æŠ¥å‘Š</p>
            <div>
                <input type="text" id="shareLink" readonly
                    class="w-full px-4 py-2 rounded-lg border border-gray-200 text-sm text-gray-600 bg-gray-50 mb-2">
                <button id="copyLinkBtn" 
                    class="w-full py-2 bg-purple-100 text-purple-700 rounded-lg text-sm font-medium hover:bg-purple-200 transition-all">
                    å¤åˆ¶é“¾æ¥
                </button>
            </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="space-y-3">
            <button id="copyTextBtn" 
                class="w-full py-3 bg-white border-2 border-purple-300 text-purple-700 font-medium rounded-2xl hover:bg-purple-50 transition-all">
                ğŸ“‹ å¤åˆ¶æ–‡å­—æŠ¥å‘Š
            </button>
            <button id="editBtn" 
                class="w-full py-3 bg-gray-100 text-gray-700 font-medium rounded-2xl hover:bg-gray-200 transition-all">
                âœï¸ è¿”å›ç¼–è¾‘
            </button>
            <button id="newReportBtn" 
                class="w-full py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold rounded-2xl shadow-lg hover:shadow-xl transition-all">
                ğŸ“ æ–°å»ºæŠ¥å‘Š
            </button>
        </div>
    </div>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyDKfklrd57Ua42UG6wMo5btzCqaf_P84kM",
            authDomain: "pet-feeding-report.firebaseapp.com",
            projectId: "pet-feeding-report",
            storageBucket: "pet-feeding-report.firebasestorage.app",
            messagingSenderId: "252784779994",
            appId: "1:252784779994:web:0eeedf2387795fc62fbbe3"
        };

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // è·å–å½“å‰é¡µé¢çš„åŸºç¡€URL
        const BASE_URL = window.location.href.replace(/\/[^\/]*$/, '');

        // å­˜å‚¨ç…§ç‰‡æ•°æ®
        let photos = {
            main: null,
            eatingBefore: null,
            eatingDuring: null,
            waste: null
        };

        // è®¾ç½®é»˜è®¤æ—¥æœŸæ—¶é—´
        document.getElementById('serviceDate').valueAsDate = new Date();
        const now = new Date();
        document.getElementById('serviceStartTime').value = 
            now.getHours().toString().padStart(2, '0') + ':' + 
            now.getMinutes().toString().padStart(2, '0');

        // æ·»åŠ å® ç‰©è¾“å…¥æ¡†
        document.getElementById('addPetBtn').addEventListener('click', function() {
            const container = document.getElementById('petNamesContainer');
            const newGroup = document.createElement('div');
            newGroup.className = 'pet-input-group mb-2';
            newGroup.innerHTML = `
                <div class="pet-input-wrapper">
                    <input type="text" name="petName" placeholder="è¯·è¾“å…¥å® ç‰©æ˜µç§°" required
                        class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 input-focus text-gray-800">
                </div>
                <button type="button" class="remove-pet-btn px-3 py-3 rounded-xl bg-red-100 text-red-500 hover:bg-red-200 transition-all">
                    âœ•
                </button>
            `;
            container.appendChild(newGroup);
            newGroup.querySelector('.remove-pet-btn').addEventListener('click', function() {
                newGroup.remove();
            });
        });

        // ä¿®å¤ï¼šToggle æŒ‰é’®é€»è¾‘ï¼ˆå¯å–æ¶ˆé€‰ä¸­ï¼‰
        document.querySelectorAll('.toggle-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const group = this.dataset.group;
                const wasActive = this.classList.contains('active');
                
                // å…ˆæ¸…é™¤åŒç»„çš„æ‰€æœ‰é€‰ä¸­
                document.querySelectorAll(`.toggle-btn[data-group="${group}"]`).forEach(b => {
                    b.classList.remove('active');
                });
                
                // å¦‚æœä¹‹å‰æ²¡é€‰ä¸­ï¼Œåˆ™é€‰ä¸­å½“å‰æŒ‰é’®
                if (!wasActive) {
                    this.classList.add('active');
                }

                // å‘•åè¯¦æƒ…æ˜¾ç¤º/éšè—
                if (group === 'vomit') {
                    const vomitDetails = document.getElementById('vomitDetails');
                    const isVomitFound = document.querySelector('.toggle-btn[data-group="vomit"][data-value="å‘ç°å‘•åç‰©"]').classList.contains('active');
                    if (isVomitFound) {
                        vomitDetails.classList.remove('hidden');
                    } else {
                        vomitDetails.classList.add('hidden');
                    }
                }
            });
        });

        // é™ªç©æ—¶é•¿æ˜¾ç¤º/éšè—
        document.getElementById('playInteraction').addEventListener('change', function() {
            const container = document.getElementById('playDurationContainer');
            if (this.checked) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        });

        // ç…§ç‰‡ä¸Šä¼ å¤„ç†å‡½æ•°
        function setupPhotoInput(inputId, previewId, photoId, photoKey) {
            document.getElementById(inputId).addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        photos[photoKey] = e.target.result;
                        document.getElementById(photoId).src = e.target.result;
                        document.getElementById(previewId).classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // ç§»é™¤ç…§ç‰‡
        function removePhoto(photoKey) {
            photos[photoKey] = null;
            if (photoKey === 'main') {
                document.getElementById('photoPreviewContainer').classList.add('hidden');
                document.getElementById('uploadPhotoBtn').textContent = 'ğŸ“· ç‚¹å‡»ä¸Šä¼ ç…§ç‰‡';
                document.getElementById('photoInput').value = '';
            } else {
                document.getElementById(photoKey + 'PhotoPreview').classList.add('hidden');
                document.getElementById(photoKey + 'PhotoInput').value = '';
            }
        }

        // è®¾ç½®å„ç§ç…§ç‰‡è¾“å…¥
        setupPhotoInput('eatingBeforePhotoInput', 'eatingBeforePhotoPreview', 'eatingBeforePhoto', 'eatingBefore');
        setupPhotoInput('eatingDuringPhotoInput', 'eatingDuringPhotoPreview', 'eatingDuringPhoto', 'eatingDuring');
        setupPhotoInput('wastePhotoInput', 'wastePhotoPreview', 'wastePhoto', 'waste');

        // ä¸»ç…§ç‰‡ä¸Šä¼ 
        document.getElementById('uploadPhotoBtn').addEventListener('click', function() {
            document.getElementById('photoInput').click();
        });

        document.getElementById('photoInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    photos.main = e.target.result;
                    document.getElementById('photoPreview').src = photos.main;
                    document.getElementById('photoPreviewContainer').classList.remove('hidden');
                    document.getElementById('uploadPhotoBtn').textContent = 'ğŸ“· æ›´æ¢ç…§ç‰‡';
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('removePhotoBtn').addEventListener('click', function() {
            removePhoto('main');
        });

        // è·å–é€‰ä¸­çš„ toggle å€¼
        function getToggleValue(group) {
            const active = document.querySelector(`.toggle-btn[data-group="${group}"].active`);
            return active ? active.dataset.value : '';
        }

        // è·å–é€‰ä¸­çš„å¤é€‰æ¡†å€¼
        function getCheckedValues(name) {
            const checkboxes = document.querySelectorAll(`input[name="${name}"]:checked`);
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // æ˜¾ç¤º/éšè—åŠ è½½é®ç½©
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // ç”ŸæˆäºŒç»´ç 
        function generateQRCode(url) {
            const qrImg = document.getElementById('qrcode');
            const encodedUrl = encodeURIComponent(url);
            qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodedUrl}`;
        }

        // è·å–å–‚é£Ÿç±»å‹åŠå“ç‰Œ
        function getFeedingTypesWithBrands() {
            const types = [];
            const typeMap = {
                'Dry': { id: 'feedingTypeDry', brandId: 'feedingBrandDry', name: 'å¹²ç²®' },
                'Wet': { id: 'feedingTypeWet', brandId: 'feedingBrandWet', name: 'æ¹¿ç²®' },
                'Can': { id: 'feedingTypeCan', brandId: 'feedingBrandCan', name: 'ç½å¤´' },
                'Snack': { id: 'feedingTypeSnack', brandId: 'feedingBrandSnack', name: 'é›¶é£Ÿ' }
            };
            
            for (const key in typeMap) {
                const checkbox = document.getElementById(typeMap[key].id);
                const brandInput = document.getElementById(typeMap[key].brandId);
                if (checkbox.checked) {
                    let typeStr = typeMap[key].name;
                    if (brandInput.value.trim()) {
                        typeStr += `(${brandInput.value.trim()})`;
                    }
                    types.push(typeStr);
                }
            }
            return types;
        }

        // è¡¨å•æäº¤
        document.getElementById('feedingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            showLoading();

            // æ”¶é›†å® ç‰©åç§°
            const petNameInputs = document.querySelectorAll('input[name="petName"]');
            const petNames = Array.from(petNameInputs).map(input => input.value).filter(name => name.trim());

            // æ”¶é›†è¡¨å•æ•°æ®
            const formData = {
                date: document.getElementById('serviceDate').value,
                startTime: document.getElementById('serviceStartTime').value,
                endTime: document.getElementById('serviceEndTime').value,
                customerAddress: document.getElementById('customerAddress').value,
                ownerName: document.getElementById('ownerName').value,
                petNames: petNames,
                bowlCleaned: document.getElementById('bowlCleaned').checked,
                feedingTypes: getFeedingTypesWithBrands(),
                feedingAmount: document.getElementById('feedingAmount').value,
                feedingUnit: document.getElementById('feedingUnit').value,
                eatingBefore: getToggleValue('eatingBefore'),
                eatingBeforePhoto: photos.eatingBefore,
                eatingDuring: getToggleValue('eatingDuring'),
                eatingDuringPhoto: photos.eatingDuring,
                waterChanged: document.getElementById('waterChanged').checked,
                dietNotes: document.getElementById('dietNotes').value,
                moodStatus: getToggleValue('mood'),
                playInteraction: document.getElementById('playInteraction').checked,
                playDuration: document.getElementById('playDuration').value,
                grooming: document.getElementById('grooming').checked,
                petStatusNotes: document.getElementById('petStatusNotes').value,
                poopStatus: getToggleValue('poop'),
                poopHasHair: document.getElementById('poopHasHair').checked,
                poopNotes: document.getElementById('poopNotes').value,
                urineCount: document.getElementById('urineCount').value,
                urineSize: getToggleValue('urineSize'),
                urineAbnormal: getToggleValue('urineAbnormal'),
                urineNotes: document.getElementById('urineNotes').value,
                wastePhoto: photos.waste,
                vomitStatus: getToggleValue('vomit'),
                vomitTypes: getCheckedValues('vomitType'),
                vomitNotes: document.getElementById('vomitNotes').value,
                doorWindowChecked: document.getElementById('doorWindowChecked').checked,
                utilitiesChecked: document.getElementById('utilitiesChecked').checked,
                surroundingCleaned: document.getElementById('surroundingCleaned').checked,
                trashHandled: document.getElementById('trashHandled').checked,
                photo: photos.main,
                notes: document.getElementById('notes').value,
                createdAt: new Date().toISOString()
            };

            try {
                // ä¿å­˜åˆ° Firebase
                const docRef = await db.collection('reports').add(formData);
                const reportId = docRef.id;

                // ç”Ÿæˆåˆ†äº«é“¾æ¥
                const shareUrl = `${BASE_URL}/view.html?id=${reportId}`;
                document.getElementById('shareLink').value = shareUrl;

                // ç”ŸæˆäºŒç»´ç 
                try {
                    generateQRCode(shareUrl);
                } catch (qrError) {
                    console.log('äºŒç»´ç ç”Ÿæˆå¤±è´¥');
                }

                // æ›´æ–°æŠ¥å‘Šé¡µé¢æ˜¾ç¤º
                updateReportDisplay(formData);

                // ä¿å­˜æ•°æ®åˆ°å…¨å±€å˜é‡
                window.reportData = formData;
                window.reportId = reportId;

                // åˆ‡æ¢é¡µé¢
                document.getElementById('formPage').classList.add('hidden');
                document.getElementById('reportPage').classList.remove('hidden');
                window.scrollTo(0, 0);

            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        });

        // æ›´æ–°æŠ¥å‘Šæ˜¾ç¤º
        function updateReportDisplay(formData) {
            // åŸºç¡€ä¿¡æ¯
            document.getElementById('reportAddress').textContent = formData.customerAddress;
            document.getElementById('reportOwner').textContent = formData.ownerName;
            document.getElementById('reportPets').textContent = formData.petNames.join('ã€');
            
            const dateObj = new Date(formData.date);
            let timeStr = formData.startTime;
            if (formData.endTime) {
                timeStr += ` - ${formData.endTime}`;
            }
            const dateStr = `${dateObj.getFullYear()}å¹´${dateObj.getMonth() + 1}æœˆ${dateObj.getDate()}æ—¥ ${timeStr}`;
            document.getElementById('reportDateTime').textContent = dateStr;
            
            // å® ç‰©çŠ¶æ€
            let moodParts = [];
            if (formData.moodStatus) moodParts.push(formData.moodStatus);
            document.getElementById('reportMood').textContent = moodParts.length > 0 ? moodParts.join(' | ') : 'æœªè®°å½•';
            
            // é™ªç©äº’åŠ¨
            if (formData.playInteraction && formData.playDuration) {
                document.getElementById('reportPlay').textContent = `é™ªç© ${formData.playDuration} åˆ†é’Ÿ`;
                document.getElementById('reportPlayContainer').classList.remove('hidden');
            } else {
                document.getElementById('reportPlayContainer').classList.add('hidden');
            }
            
            // æ¢³æ¯›
            if (formData.grooming) {
                document.getElementById('reportGroomingContainer').classList.remove('hidden');
            } else {
                document.getElementById('reportGroomingContainer').classList.add('hidden');
            }

            // å® ç‰©çŠ¶æ€å¤‡æ³¨
            if (formData.petStatusNotes) {
                document.getElementById('reportPetStatusNotes').textContent = formData.petStatusNotes;
                document.getElementById('reportPetStatusNotesContainer').classList.remove('hidden');
            } else {
                document.getElementById('reportPetStatusNotesContainer').classList.add('hidden');
            }
            
            // é¥®é£Ÿç…§æ–™
            let feedingParts = [];
            if (formData.bowlCleaned) feedingParts.push('ç¢—å·²æ¸…æ´—');
            if (formData.feedingTypes.length > 0) feedingParts.push(`å–‚é£Ÿï¼š${formData.feedingTypes.join('ã€')}`);
            if (formData.feedingAmount) feedingParts.push(`å–‚é£Ÿé‡ï¼š${formData.feedingAmount}${formData.feedingUnit}`);
            if (formData.eatingBefore) feedingParts.push(`æœåŠ¡å‰ï¼š${formData.eatingBefore}`);
            if (formData.eatingDuring) feedingParts.push(`æœåŠ¡æ—¶ï¼š${formData.eatingDuring}`);
            if (formData.waterChanged) feedingParts.push('å·²æ¢æ°´');
            if (formData.dietNotes) feedingParts.push(`å¤‡æ³¨ï¼š${formData.dietNotes}`);
            document.getElementById('reportFeeding').textContent = feedingParts.length > 0 ? feedingParts.join(' | ') : 'æœªå¡«å†™';
            
            // å«ç”Ÿæ¸…æ´
            let cleaningParts = [];
            if (formData.poopStatus) {
                let poopText = `æ’ä¾¿ï¼š${formData.poopStatus}`;
                if (formData.poopHasHair) poopText += '(æœ‰æ¯›å‘)';
                if (formData.poopNotes) poopText += ` - ${formData.poopNotes}`;
                cleaningParts.push(poopText);
            }
            if (formData.urineCount || formData.urineSize) {
                let urineText = 'å°¿å›¢ï¼š';
                if (formData.urineCount) urineText += `${formData.urineCount}ä¸ª`;
                if (formData.urineSize) urineText += ` ${formData.urineSize}`;
                if (formData.urineAbnormal && formData.urineAbnormal !== 'æ— å¼‚å¸¸') urineText += ` (${formData.urineAbnormal})`;
                if (formData.urineNotes) urineText += ` - ${formData.urineNotes}`;
                cleaningParts.push(urineText);
            }
            document.getElementById('reportCleaning').textContent = cleaningParts.length > 0 ? cleaningParts.join(' | ') : 'æœªå¡«å†™';
            
            // å‘•åæƒ…å†µ
            if (formData.vomitStatus === 'å‘ç°å‘•åç‰©') {
                let vomitText = 'å‘ç°å‘•åç‰©';
                if (formData.vomitTypes.length > 0) {
                    vomitText += ` (${formData.vomitTypes.join(', ')})`;
                }
                if (formData.vomitNotes) {
                    vomitText += ` - å¤‡æ³¨ï¼š${formData.vomitNotes}`;
                }
                document.getElementById('reportVomit').textContent = vomitText;
                document.getElementById('reportVomitContainer').classList.remove('hidden');
            } else {
                document.getElementById('reportVomitContainer').classList.add('hidden');
            }
            
            // ç…§ç‰‡
            if (formData.photo) {
                document.getElementById('reportPhoto').src = formData.photo;
                document.getElementById('reportPhotoContainer').classList.remove('hidden');
            } else {
                document.getElementById('reportPhotoContainer').classList.add('hidden');
            }
            
            // ç¯å¢ƒæ£€æŸ¥
            let envParts = [];
            if (formData.doorWindowChecked) envParts.push('é—¨çª—å·²ç¡®è®¤é”å¥½');
            if (formData.utilitiesChecked) envParts.push('æ°´ç”µ/ç©ºè°ƒå·²å¤åŸ');
            if (formData.surroundingCleaned) envParts.push('å‘¨è¾¹æ¸…æ´/è¡¥ç ‚');
            if (formData.trashHandled) envParts.push('åƒåœ¾å·²å¤„ç†');
            document.getElementById('reportEnvironment').textContent = envParts.length > 0 ? envParts.join(' | ') : 'æœªæ£€æŸ¥';
            
            // å¤‡æ³¨
            if (formData.notes) {
                document.getElementById('reportNotes').textContent = formData.notes;
                document.getElementById('reportNotesContainer').classList.remove('hidden');
            } else {
                document.getElementById('reportNotesContainer').classList.add('hidden');
            }
        }

        // å¤åˆ¶é“¾æ¥
        document.getElementById('copyLinkBtn').addEventListener('click', function() {
            const linkInput = document.getElementById('shareLink');
            linkInput.select();
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(linkInput.value).then(() => {
                    alert('âœ… é“¾æ¥å·²å¤åˆ¶ï¼');
                }).catch(() => {
                    document.execCommand('copy');
                    alert('âœ… é“¾æ¥å·²å¤åˆ¶ï¼');
                });
            } else {
                document.execCommand('copy');
                alert('âœ… é“¾æ¥å·²å¤åˆ¶ï¼');
            }
        });

        // å¤åˆ¶æ–‡å­—æŠ¥å‘Š
        document.getElementById('copyTextBtn').addEventListener('click', function() {
            const data = window.reportData;
            const dateObj = new Date(data.date);
            let timeStr = data.startTime;
            if (data.endTime) timeStr += ` - ${data.endTime}`;
            const dateStr = `${dateObj.getFullYear()}å¹´${dateObj.getMonth() + 1}æœˆ${dateObj.getDate()}æ—¥ ${timeStr}`;
            
            let text = `ã€ä¸Šé—¨å–‚å…»æŠ¥å‘Šã€‘\n`;
            text += `ğŸ“ åœ°å€ï¼š${data.customerAddress}\n`;
            text += `ğŸ‘¤ ä¸»äººï¼š${data.ownerName}\n`;
            text += `ğŸ¾ å® ç‰©ï¼š${data.petNames.join('ã€')}\n`;
            text += `ğŸ“… æ—¶é—´ï¼š${dateStr}\n\n`;
            
            text += `ğŸ˜º å® ç‰©çŠ¶æ€ï¼š${data.moodStatus || 'æœªè®°å½•'}\n`;
            if (data.playInteraction && data.playDuration) {
                text += `ğŸ® é™ªç©äº’åŠ¨ï¼š${data.playDuration} åˆ†é’Ÿ\n`;
            }
            if (data.grooming) {
                text += `âœ¨ æ¢³æ¯›ï¼šå·²æ¢³æ¯›\n`;
            }
            if (data.petStatusNotes) {
                text += `ğŸ“ å® ç‰©çŠ¶æ€å¤‡æ³¨ï¼š${data.petStatusNotes}\n`;
            }
            
            text += `\nğŸ½ï¸ é¥®é£Ÿç…§æ–™ï¼š\n`;
            if (data.feedingTypes.length > 0) {
                text += `  å–‚é£Ÿï¼š${data.feedingTypes.join('ã€')}\n`;
            }
            if (data.feedingAmount) {
                text += `  å–‚é£Ÿé‡ï¼š${data.feedingAmount}${data.feedingUnit}\n`;
            }
            if (data.eatingBefore) text += `  æœåŠ¡å‰è¿›é£Ÿï¼š${data.eatingBefore}\n`;
            if (data.eatingDuring) text += `  æœåŠ¡æ—¶è¿›é£Ÿï¼š${data.eatingDuring}\n`;
            if (data.bowlCleaned) text += `  âœ“ ç²®ç¢—/æ°´ç¢—å·²æ¸…æ´—\n`;
            if (data.waterChanged) text += `  âœ“ å·²æ¢æ°´\n`;
            if (data.dietNotes) text += `  å¤‡æ³¨ï¼š${data.dietNotes}\n`;
            
            text += `\nğŸ’© å«ç”Ÿæ¸…æ´ï¼š\n`;
            if (data.poopStatus) {
                let poopText = data.poopStatus;
                if (data.poopHasHair) poopText += ` (æœ‰æ¯›å‘)`;
                if (data.poopNotes) poopText += ` - ${data.poopNotes}`;
                text += `  æ’ä¾¿ï¼š${poopText}\n`;
            }
            if (data.urineCount || data.urineSize) {
                let urineText = '';
                if (data.urineCount) urineText += `${data.urineCount}ä¸ª`;
                if (data.urineSize) urineText += ` ${data.urineSize}`;
                if (data.urineAbnormal && data.urineAbnormal !== 'æ— å¼‚å¸¸') urineText += ` (${data.urineAbnormal})`;
                if (data.urineNotes) urineText += ` - ${data.urineNotes}`;
                text += `  å°¿å›¢ï¼š${urineText}\n`;
            }
            
            if (data.vomitStatus === 'å‘ç°å‘•åç‰©') {
                text += `\nğŸ¤® å‘•åæƒ…å†µï¼š\n`;
                let vomitText = 'å‘ç°å‘•åç‰©';
                if (data.vomitTypes.length > 0) {
                    vomitText += ` (${data.vomitTypes.join(', ')})`;
                }
                if (data.vomitNotes) {
                    vomitText += ` - ${data.vomitNotes}`;
                }
                text += `  ${vomitText}\n`;
            }
            
            text += `\nğŸ  ç¯å¢ƒæ£€æŸ¥ï¼š\n`;
            if (data.doorWindowChecked) text += `  âœ“ é—¨çª—å·²ç¡®è®¤é”å¥½\n`;
            if (data.utilitiesChecked) text += `  âœ“ æ°´ç”µ/ç©ºè°ƒå·²å¤åŸ\n`;
            if (data.surroundingCleaned) text += `  âœ“ å‘¨è¾¹æ¸…æ´/è¡¥ç ‚\n`;
            if (data.trashHandled) text += `  âœ“ åƒåœ¾å·²å¤„ç†\n`;
            
            if (data.notes) {
                text += `\nğŸ“ å¤‡æ³¨ï¼š${data.notes}`;
            }
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('âœ… æ–‡å­—æŠ¥å‘Šå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                }).catch(() => {
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        });

        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                alert('âœ… æ–‡å­—æŠ¥å‘Šå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            } catch (err) {
                alert('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            }
            document.body.removeChild(textarea);
        }

        // è¿”å›ç¼–è¾‘
        document.getElementById('editBtn').addEventListener('click', function() {
            document.getElementById('formPage').classList.remove('hidden');
            document.getElementById('reportPage').classList.add('hidden');
            window.scrollTo(0, 0);
        });

        // æ–°å»ºæŠ¥å‘Š
        document.getElementById('newReportBtn').addEventListener('click', function() {
            if (confirm('ç¡®å®šè¦æ–°å»ºæŠ¥å‘Šå—ï¼Ÿå½“å‰è¡¨å•å†…å®¹å°†è¢«æ¸…ç©ºã€‚')) {
                document.getElementById('feedingForm').reset();
                document.getElementById('serviceDate').valueAsDate = new Date();
                const now = new Date();
                document.getElementById('serviceStartTime').value = 
                    now.getHours().toString().padStart(2, '0') + ':' + 
                    now.getMinutes().toString().padStart(2, '0');
                
                // æ¸…é™¤é¢å¤–çš„å® ç‰©è¾“å…¥æ¡†
                const container = document.getElementById('petNamesContainer');
                const groups = container.querySelectorAll('.pet-input-group');
                groups.forEach((group, index) => {
                    if (index > 0) group.remove();
                });
                
                // æ¸…é™¤ toggle é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.toggle-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // æ¸…é™¤æ‰€æœ‰ç…§ç‰‡
                photos = { main: null, eatingBefore: null, eatingDuring: null, waste: null };
                document.getElementById('photoPreviewContainer').classList.add('hidden');
                document.getElementById('uploadPhotoBtn').textContent = 'ğŸ“· ç‚¹å‡»ä¸Šä¼ ç…§ç‰‡';
                document.getElementById('photoInput').value = '';
                document.getElementById('eatingBeforePhotoPreview').classList.add('hidden');
                document.getElementById('eatingDuringPhotoPreview').classList.add('hidden');
                document.getElementById('wastePhotoPreview').classList.add('hidden');
                
                // éšè—æ¡ä»¶æ˜¾ç¤ºçš„å…ƒç´ 
                document.getElementById('vomitDetails').classList.add('hidden');
                document.getElementById('playDurationContainer').classList.add('hidden');
                
                // åˆ‡æ¢é¡µé¢
                document.getElementById('formPage').classList.remove('hidden');
                document.getElementById('reportPage').classList.add('hidden');
                window.scrollTo(0, 0);
            }
        });
    </script>
</body>
</html>
